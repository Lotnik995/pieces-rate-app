<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KL-6 — Piece Rate (Dark Clean)</title>
  <meta name="theme-color" content="#0d0f15"/>
  <style>
    :root{
      --bg:#0d0f15;
      --card:#12141a;
      --muted:#9aa0b2;
      --text:#e6eef8;
      --accent-1:#6b5cff;
      --accent-2:#4f7dff;
      --glass: rgba(255,255,255,0.02);
      --border: rgba(255,255,255,0.04);
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,Segoe UI,Roboto,Arial, system-ui;
      background:linear-gradient(180deg,#0b0c0f,#0d0f15);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:14px;
    }
    .wrap{max-width:1100px;margin:12px auto;padding:12px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:800}
    h1{margin:0;font-size:18px}
    .subtitle{color:var(--muted);font-size:13px}
    .actions{display:flex;gap:8px;align-items:center}
    .btn{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));border:0;color:white;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:0 8px 20px rgba(79,61,255,0.08)}
    .btn.ghost{background:transparent;color:var(--accent-2);border:1px solid var(--border)}
    .card{background:linear-gradient(180deg,var(--card),#0f1116);border-radius:var(--radius);padding:14px;border:1px solid var(--border);box-shadow:0 10px 30px rgba(0,0,0,0.6)}
    .layout{display:grid;grid-template-columns:1fr 360px;gap:16px}
    @media (max-width:920px){ .layout{grid-template-columns:1fr} header{flex-direction:column;align-items:flex-start} .actions{width:100%;flex-wrap:wrap} }
    .tabs{display:flex;gap:8px;overflow:auto;padding:6px 0;margin-bottom:12px}
    .tab{padding:8px 10px;border-radius:999px;background:transparent;border:1px solid transparent;color:var(--muted);font-weight:700;cursor:pointer}
    .tab.active{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:white}
    .form-row{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
    select,input[type="text"],input[type="number"]{background:#0b0c0f;border:1px solid var(--border);padding:9px;border-radius:8px;color:var(--text)}
    .save-pill{padding:8px 12px;border-radius:999px;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:#fff;border:none;cursor:pointer}
    .entries{display:flex;flex-direction:column;gap:10px}
    .entry{display:grid;grid-template-columns:1fr 110px 90px 100px 60px;gap:8px;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid var(--border)}
    .entry .type{font-weight:700}
    .entry .small{color:var(--muted);font-size:13px}
    .entry .right{text-align:right}
    .entry .del{background:transparent;border:1px solid var(--border);color:var(--muted);padding:6px;border-radius:8px;cursor:pointer}
    @media (max-width:700px){ .entry{grid-template-columns:1fr;gap:6px;padding:12px} .form-row{flex-direction:column} .form-row>*{width:100%} }
    .totals .big{font-size:20px;font-weight:800}
    .history-list{max-height:260px;overflow:auto;padding:6px;border-radius:8px;background:var(--glass)}
    footer{margin-top:12px;color:var(--muted);font-size:13px;text-align:center}
    .small{font-size:13px;color:var(--muted)}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">KL-6</div>
        <div>
          <h1>KL-6 — Piece Rate Tracker</h1>
          <div class="subtitle">Dark • Mobile-first • Price per tray</div>
        </div>
      </div>
      <div class="actions">
        <button id="exportCsv" class="btn ghost">Export CSV</button>
        <button id="saveWeekBtn" class="btn">Save week</button>
        <button id="resetAll" class="btn ghost">Reset</button>
      </div>
    </header>

    <div class="card">
      <div class="tabs" id="weekTabs"></div>

      <div class="layout">
        <main>
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:12px;flex-wrap:wrap">
            <div>
              <div class="small muted">Active day</div>
              <div id="activeDayLabel" style="font-size:18px;font-weight:800">Monday</div>
            </div>
            <div>
              <div class="small muted">Workers today</div>
              <input id="teamInput" type="number" min="1" value="5" style="width:110px"/>
            </div>
          </div>

          <div class="card" style="margin-bottom:12px">
            <div class="form-row" style="align-items:center">
              <select id="presetType" style="min-width:220px"></select>
              <input id="pricePerTray" type="text" placeholder="Price per tray (e.g. 0.557)" style="width:140px"/>
              <input id="traysQty" type="number" min="0" value="0" style="width:110px"/>
              <button id="addEntry" class="save-pill">Add</button>
            </div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="addType" class="btn ghost">+ New type</button>
              <button id="editWeekWorkers" class="btn ghost">Edit week workers</button>
            </div>
          </div>

          <div class="card" style="margin-bottom:12px">
            <div style="font-weight:800;margin-bottom:8px">Entries</div>
            <div class="entries" id="entriesBody"></div>
          </div>

          <div class="small muted">Tip: choose a tray type to prefill price; prices save until you change them.</div>
        </main>

        <aside>
          <div class="card totals" style="margin-bottom:12px">
            <div class="small muted">Daily total</div>
            <div id="dailyTotal" class="big">£0.00</div>
            <div id="dailyPer" class="small muted">Per person: £0.00</div>
            <hr style="border:none;border-top:1px solid var(--border);margin:12px 0"/>
            <div class="small muted">Weekly total</div>
            <div id="weeklyTotal" class="big">£0.00</div>
            <div id="weeklyPer" class="small muted">Weekly per-worker: £0.00</div>
          </div>

          <div class="card" style="margin-bottom:12px">
            <div style="font-weight:800;color:var(--accent-2);margin-bottom:6px">Week history</div>
            <div class="history-list" id="historyList"></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="viewWeek" class="btn ghost" style="flex:1">View</button>
              <button id="deleteWeek" class="btn ghost" style="flex:1">Delete</button>
            </div>
          </div>

          <div class="card">
            <div style="font-weight:800;color:var(--accent-2);margin-bottom:6px">Monthly totals</div>
            <select id="monthSelect" class="month-select"></select>
            <div id="monthlySummary" class="small muted" style="margin-top:10px"></div>
            <button id="exportMonth" class="btn ghost" style="margin-top:10px;width:100%">Export month</button>
          </div>
        </aside>
      </div>
    </div>

    <footer class="muted">Saved locally in your browser • Weeks archived when you press "Save week"</footer>
  </div>

<script>
/* Clean single-version JS for Dark KL-6 app */

/* STORAGE KEYS */
const STORAGE_KEY = 'kl6_clean_dark_v1';

/* DEFAULT TRAY TYPES (per tray prices, strings to preserve precision input) */
const DEFAULT_TRAYS = [
  {id:'x8-bagged', name:'x8 bagged', price:'0.560'},
  {id:'x8-naked',  name:'x8 naked',  price:'0.480'},
  {id:'x6-naked',  name:'x6 naked',  price:'0.430'},
  {id:'x11-naked', name:'11 naked',  price:'0.510'},
  {id:'x8-1st',    name:'8 1st class', price:'0.590'},
  {id:'x6-1st',    name:'6 1st class', price:'0.510'},
  {id:'x7-1st',    name:'7 1st class', price:'0.520'},
  {id:'x8-2nd',    name:'8 2nd class', price:'0.350'},
  {id:'x6-2nd',    name:'6 2nd class', price:'0.300'}
];

/* DAYS */
const DAYS = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];

/* STATE */
let state = {
  trays: [],
  week: {},
  archive: {}
};
let activeDay = 0;

/* ELEMENTS */
const presetSelect = document.getElementById('presetType');
const pricePerTray = document.getElementById('pricePerTray');
const traysQty = document.getElementById('traysQty');
const addEntryBtn = document.getElementById('addEntry');
const addTypeBtn = document.getElementById('addType');
const editWeekWorkersBtn = document.getElementById('editWeekWorkers');
const entriesBody = document.getElementById('entriesBody');

const weekTabs = document.getElementById('weekTabs');
const activeDayLabel = document.getElementById('activeDayLabel');
const teamInput = document.getElementById('teamInput');

const dailyTotalEl = document.getElementById('dailyTotal');
const dailyPerEl = document.getElementById('dailyPer');
const weeklyTotalEl = document.getElementById('weeklyTotal');
const weeklyPerEl = document.getElementById('weeklyPer');

const historyList = document.getElementById('historyList');
const saveWeekBtn = document.getElementById('saveWeekBtn');
const exportCsvBtn = document.getElementById('exportCsv');
const resetAllBtn = document.getElementById('resetAll');
const monthSelect = document.getElementById('monthSelect');
const monthlySummary = document.getElementById('monthlySummary');
const viewWeekBtn = document.getElementById('viewWeek');
const deleteWeekBtn = document.getElementById('deleteWeek');
const exportMonthBtn = document.getElementById('exportMonth');

/* UTIL */
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}
function initState(){
  const saved = loadState();
  if(saved){
    state = saved;
    // ensure structure
    if(!state.trays) state.trays = DEFAULT_TRAYS.slice();
    if(!state.week){
      state.week = {};
      DAYS.forEach(d=> state.week[d] = {workers:5, entries:[]});
    }
    if(!state.archive) state.archive = {};
  } else {
    state.trays = DEFAULT_TRAYS.slice();
    state.week = {};
    DAYS.forEach(d=> state.week[d] = {workers:5, entries:[]});
    state.archive = {};
    saveState();
  }
  // ensure activeDay valid
  activeDay = Number(localStorage.getItem('kl6_active_day') || 0);
  if(activeDay<0||activeDay>6) activeDay = 0;
}

/* RENDER */
function renderTabs(){
  weekTabs.innerHTML = '';
  DAYS.forEach((d,i)=>{
    const b = document.createElement('button');
    b.className = 'tab' + (i===activeDay?' active':'');
    b.textContent = d.slice(0,3);
    b.title = d;
    b.onclick = ()=>{ activeDay = i; localStorage.setItem('kl6_active_day', String(activeDay)); renderAll(); };
    weekTabs.appendChild(b);
  });
}
function renderTraySelect(){
  presetSelect.innerHTML = '';
  state.trays.forEach(t=>{
    const o = document.createElement('option'); o.value = t.id; o.text = t.name; presetSelect.appendChild(o);
  });
  // set price field to selected tray price
  const sel = state.trays.find(t=>t.id===presetSelect.value) || state.trays[0];
  if(sel) pricePerTray.value = sel.price
